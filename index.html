<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Proyecto 1</title>
    <style type="text/css">
        * {
            margin: auto;
            padding: 0;
        }

        h1 {
            padding: 0.5em;
            text-align: center;
        }

        #cronometro {
            padding: 10px;
            width: 200px;
            color: white;
            text-align: center;
        }

        #reloj {
            padding: 5px 10px;
            width: 170px;
            border: 1px solid black;
            font-weight: bold;
            font-size: x-large;
            text-align: center;
            margin: 4px;
        }

        #cronometro [type=button] {
            margin: 4px;
            font: normal 9pt arial;
        }
    </style>

    <link href="css/bootstrap.min.css" rel="stylesheet" />
	<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <script type="text/javascript" src="js/paper.js"></script>
    <script src="js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>

    <script type="text/javascript">
        paper.install(window);
        var modoJuego = false;

        // Capas de fondo, pista y auto
        var bgLayer;
        var pistaLayer;
        var autoLayer;

        // Variables de la pista (segmentos) y camino
        var pista;
        var path;
        var puntoInicial;
        var segmentosLimpios;

        // Angulo inicial;
        var autoAngulo0;
        var autoPosicion0;

        // Variables del auto
        var auto;
        var chasis;
        var cabina;
        var llantaDI;
        var llantaDD;
        var llantaTI;
        var llantaTD;
        var luzDI;
        var luzDD;
        var sirena;
        var basesirena;

        var autoVelocidad;
        var autoAngulo;

        window.onload = function () {
            paper.setup('myCanvas');

            // Inicializar las capas
            bgLayer = new Layer();
            pistaLayer = new Layer();
            pistaOverlayLayer = new Layer();
            autoLayer = new Layer();

            // A la capa de pista le incluye el objeto pista
            pista = new Group();
            pistaLayer.addChild(pista);

            var tool = new Tool();
            tool.minDistance = 10;
            tool.maxDistance = 45;

            // Al hacer click, se inicia a pintar una pista
            tool.onMouseDown = function (event) {
                if (modoJuego) {
                    return;
                }
                pista.clear();
                path = new Path();
                pista.addChild(path);
                path.strokeColor = '#00000';
                path.selected = true;

                autoPosicion0 = event.point;
                path.add(event.point);
                puntoInicial = event.point;
            };

            // Al arrastrar el mouse, se pinta los segmentos de pista
            tool.onMouseDrag = function (event) {
                if (modoJuego) {
                    return;
                }
                var step = event.delta;
                autoAngulo0 = step.angle;
                step.angle += 90;

                var top = event.middlePoint.add(step);
                var bottom = event.middlePoint.subtract(step);

                var line = new Path();
                line.strokeColor = '#000000';
                line.add(top);
                line.add(bottom);
                pista.addChild(line);

                path.add(top);
                path.insert(0, bottom);
            };

            // Si se utilizan las fechas, mueve el auto
            tool.onKeyDown = function (event) {
                if (!modoJuego) {
                    return;
                };
                if (auto == null) {
                    return;
                };
                event.preventDefault();
                // Se aumenta la velocidad
                if (event.key == 'up') {

                    autoVelocidad += 5;
                    autoVelocidad = Math.min(autoVelocidad + 5, 15);
                };
                // Se disminuye la velocidad
                if (event.key == 'down') {
                    autoVelocidad = Math.max(autoVelocidad - 2.5, -15);
                };
                // Se gira el auto a la izquierda
                if (event.key == 'left') {
                    autoAngulo = autoAngulo - (Math.PI / 180) * 5;
                    auto.rotate(-5);
                };
                // Se gira el auto a la derecha
                if (event.key == 'right') {
                    autoAngulo = autoAngulo + (Math.PI / 180) * 5;
                    auto.rotate(5);
                };
            };

            // En cada frame
            view.onFrame = function (event) {
                if (modoJuego) {
                    if (auto != null) {
                        sirena.rotate(3, auto.position);
                        // Se actualiza la ubicacion del auto, segun la velocidad
                        var xp = auto.position.x + (Math.cos(autoAngulo) * autoVelocidad);
                        var yp = auto.position.y + (Math.sin(autoAngulo) * autoVelocidad);
                        auto.position.x = Math.max(0, Math.min(xp, view.size.width));
                        auto.position.y = Math.max(0, Math.min(yp, view.size.height));
                        autoVelocidad = autoVelocidad * 0.9;


                        // Verifica que se encuentre sobre un poligono
                        var hitResult = pistaOverlayLayer.hitTest(auto.position);
                        if (hitResult) {
                            if (hitResult.item.flag == null) {
                                hitResult.item.flag = true;
                                auto.scale((hitResult.item.bounds.height) / (auto.bounds.height));
                                hitResult.item.style.fillColor = 'green';
                                segmentosLimpios++;
                            }
                        };

                        // Verifica el final de juego
                        if (segmentosLimpios == pistaOverlayLayer.children.length) {

                            parar();
                            if (cro < bestcro) {
                                var person = prompt("Haz hecho el mejor registro!, escribe tu nombre", "Player 1");

                                if (person != null) {
                                    parar();
                                    x = "Mejor Tiempo = " + person + " -> " + document.getElementById("reloj").innerHTML + "<br>";
                                    document.getElementById("bestplayer").innerHTML = x;
                                }
                                bestcro = cro;
                            }
                            else {
                                alert('Fin del juego. Todavía no eres el mejor :(');
                            }
                            segmentosLimpios++; // Para solo mostrar una alerta una vez
                            reiniciar();
                        };

                        tiempo

                    };
                };
            };

        }

        // En modo dibujar pista, limpia la pista actual y limpia la capa de auto
        function dibujarPista() {
            modoJuego = false;
            pista.clear();
            autoLayer.clear();
            pistaOverlayLayer.clear();
            bestcro = 99999999999999999999;
            document.getElementById("bestplayer").innerHTML = "";
        };

        // En modo juego, se incluye un nuevo auto y se inicia con angulo 0, velocidad 0
        function jugar() {
            if (pista.children.length <= 1) {
                alert('No se ha dibujado una pista');
                return;
            }

            modoJuego = true;
            segmentosLimpios = 0;
			reiniciar();
            empezar();

            // Limpio la capa del auto e inicializo un nuevo auto
            autoLayer.clear();
            auto = new Group();

            chasis = new Path.Rectangle(new Point(50, 50), new Size(100, 50));
            chasis.style = {
                fillColor: 'white',
                strokeColor: 'black'
            };
            auto.addChild(chasis);

            cabina = new Path.Rectangle(new Point(50 + 25, 50), new Size(50, 50));
            cabina.style = {
                fillColor: 'red',
                strokeColor: 'black'
            };
            auto.addChild(cabina);

            llantaDI = new Path.RoundRectangle(new Rectangle(new Point(50 + 10, 50 - 5), new Point(80, 55 - 5)), new Size(2, 2));
            llantaDD = new Path.RoundRectangle(new Rectangle(new Point(150 - 30, 50 - 5), new Point(140, 55 - 5)), new Size(2, 2));
            llantaTI = new Path.RoundRectangle(new Rectangle(new Point(50 + 10, 100), new Point(80, 105)), new Size(2, 2));
            llantaTD = new Path.RoundRectangle(new Rectangle(new Point(150 - 30, 100), new Point(140, 105)), new Size(2, 2));
            llantaDI.fillColor = 'black';
            llantaDD.fillColor = 'black';
            llantaTI.fillColor = 'black';
            llantaTD.fillColor = 'black';
            auto.addChild(llantaDI);
            auto.addChild(llantaDD);
            auto.addChild(llantaTI);
            auto.addChild(llantaTD);

            luzDI = new Path();
            luzDI.add(new Point(45, 15 + 50));
            luzDI.add(new Point(45, 5 + 50));
            luzDI.add(new Point(50, 10 + 50));
            luzDI.closed = true;
            luzDD = new Path();
            luzDD.add(new Point(45, 45 + 50));
            luzDD.add(new Point(45, 35 + 50));
            luzDD.add(new Point(50, 40 + 50));
            luzDD.closed = true;
            luzDD.fillColor = 'yellow';
            luzDD.strokeColor = 'black';
            luzDI.fillColor = 'yellow';
            luzDI.strokeColor = 'black';
            auto.addChild(luzDD);
            auto.addChild(luzDD);
            auto.addChild(luzDI);
            auto.addChild(luzDI);

            basesirena = new Path.Circle(new Point(50 + 50, 50 + 25), 5);
            basesirena.fillColor = 'blue';
            auto.addChild(basesirena);

            sirena = new Path();
            sirena.add(new Point(50 + 50 - 5, 50 + 25 + 25));
            sirena.add(new Point(50 + 50, 50 + 25));
            sirena.add(new Point(50 + 50 + 5, 50 + 25 + 25));
            sirena.closed = true;
            sirena.fillColor = 'blue';
            auto.addChild(sirena);

            autoLayer.addChild(auto);
            autoVelocidad = 0;

            autoAngulo = (autoAngulo0 + 360) * (Math.PI / 180);
            auto.rotate(autoAngulo0 + 180);
            auto.position = autoPosicion0;

            // Defino los poligonos de la pista
            // Comienzo en 1 porque la linea esta incluida, y termino antes del ultimo
            // puesto que debo completar un poligono al final de la pista
            pistaOverlayLayer.clear();
            for (var i = 0; i < pista.children.length - 1; i++) {

                // Obtiene los puntos de la linea
                var p1;
                var p2;
                var p3;
                var p4;
                if (i == 0) {
                    p1 = puntoInicial;
                    p2 = puntoInicial;
                } else {
                    p1 = new Point(pista.children[i].getSegments()[0].getPoint().x, pista.children[i].getSegments()[0].getPoint().y);
                    p2 = new Point(pista.children[i].getSegments()[1].getPoint().x, pista.children[i].getSegments()[1].getPoint().y);
                }
                p3 = new Point(pista.children[i + 1].getSegments()[1].getPoint().x, pista.children[i + 1].getSegments()[1].getPoint().y);
                p4 = new Point(pista.children[i + 1].getSegments()[0].getPoint().x, pista.children[i + 1].getSegments()[0].getPoint().y);

                var poligono = new Path();
                poligono.add(p1);
                poligono.add(p2);
                poligono.add(p3);
                poligono.add(p4);
                poligono.closed = true;
                poligono.style = {
                    fillColor: 'red',
                    strokeColor: 'black'
                };
                pistaOverlayLayer.addChild(poligono);
            };

            var now = new Date();


        };


        //variables de inicio:
        var marcha = 0; //control del temporizador
        var cro = 0; //estado inicial del cronómetro.
        var bestcro = 99999999999999999;
        //cronometro en marcha. Empezar en 0:
        function empezar() {
            if (marcha == 0) { //solo si el cronómetro esta parado
                emp = new Date() //fecha actual
                elcrono = setInterval(tiempo, 10); //función del temporizador.
                marcha = 1 //indicamos que se ha puesto en marcha.
            }
        }
        function tiempo() { //función del temporizador
            actual = new Date() //fecha en el instante
            cro = actual - emp //tiempo transcurrido en milisegundos
            cr = new Date() //fecha donde guardamos el tiempo transcurrido
            cr.setTime(cro)
            cs = cr.getMilliseconds() //milisegundos del cronómetro
            cs = cs / 10; //paso a centésimas de segundo.
            cs = Math.round(cs)
            sg = cr.getSeconds(); //segundos del cronómetro
            mn = cr.getMinutes(); //minutos del cronómetro
            ho = cr.getHours() - 1; //horas del cronómetro
            if (cs < 10) { cs = "0" + cs; }  //poner siempre 2 cifras en los números
            if (sg < 10) { sg = "0" + sg; }
            if (mn < 10) { mn = "0" + mn; }
            document.getElementById("reloj").innerHTML = mn + " : " + sg + " : " + cs; //pasar a pantalla.
        }
        //parar el cronómetro
        function parar() {
            if (marcha == 1) { //sólo si está en funcionamiento
                clearInterval(elcrono); //parar el crono
                marcha = 0; //indicar que está parado.
            }
        }


        //Volver al estado inicial
        function reiniciar() {
            if (marcha == 1) { //si el cronómetro está en marcha:
                clearInterval(elcrono); //parar el crono
                marcha = 0;	//indicar que está parado
            }
            cro = 0; //tiempo transcurrido a cero
            document.getElementById("reloj").innerHTML = "00 : 00 : 00"; //visor a cero
        }

    </script>

</head>
<body style="font-family: roboto; overflow: hidden; background-image: url('img/bg.jpg');">
    <div id="cronometro">
        <div id="reloj">00 : 00 : 00</div>
    </div>

    <div style="width:300px; position: absolute; left: 10px; top: 10px; color: white;">
        <p style="font-weight:bold:" id="bestplayer"></p>
    </div>
    <div style="position: absolute; right: 10px; top: 10px;">
        <button type="button" class="btn btn-primary" onClick="dibujarPista();">Dibujar Pista</button>&nbsp;
        <button type="button" class="btn btn-primary" onClick="jugar();">Iniciar/Reiniciar</button>
    </div>
    <canvas id="myCanvas" resize></canvas>
</body>
</html>
